\documentclass[thesis]{subfiles}

\begin{document}

\OnlyInSubfile{\setcounter{chapter}{3}}

\chapter{First Principles simulations}
\startcontents[chapters]
\printpartialtoc

\vskip2em

As discussed in the previous chapter, we need to be able to compute the total
energy of this system in every possible configuration in order to be able to
compute the properties of an atomic system using the framework of statistical
physics. It is possible to do so by considering the quantum nature of the
electrons, and solving the the Schrödinger equation for this system. I will not
however consider the quantum nature of the atomic nuclei, as it is most of the
time not required for the description of the system. Solving the Schrödinger
equation presents the advantage that no additional hypothesis has to be made
about the system, and the functional form of the interaction potential
$\mathcal{V}(\r^N)$.

In this chapter, I will first introduce the Density Functional Theory approach
to solving the Schrödinger equation. I will then explain how I used it to run
\abinitio molecular dynamics to study deformations of \ZIF8 under \ce{N2}
adsorption. Finally, I will discuss how we can use DFT simulations to
parametrize a classical force field, allowing us to study bigger systems on
longer timescales at the cost of some accuracy.

\newpage

\section{From Schrödinger to Density Functional Theory}
\label{sec:dft}
\subsection{The Schrödinger equation}

In the quantum chemistry, the state of a system is represented by a
complex-valued function of positions and time $\Psi(\r, t)$ called the
\emph{wave function}. The Schrödinger equation\cite{Schrodinger1926} describes
the time evolution of this function given the Hamiltonian $\hat{\mathcal{H}}$ of
the system:
\[\hat{\mathcal{H}} \Psi(\r, t) = i\hbar \frac{\partial}{\partial t} \Psi(\r, t),\label{eq:time-schrodinger}\]
where $i$ is the imaginary number, and $\hbar$ the reduced Plank's constant. The
quantum Hamiltonian operator $\hat{\mathcal{H}}$ can be expressed as a sum of
quantum kinetic energy and potential energy operators:
\[\hat{\mathcal{H}} = \sum_i \frac{- \hbar^2}{2m_i} \nabla_i^2 + V(\r)\]
where the $m$ are the masses of the particles in the system, $\nabla$ is the
differential nabla operator, and $V(\r)$ is the potential energy of the system.
When the potential energy does not explicitly depend on time, we can look for
solution with separated variables of the form:
\[\Psi(\r, t) = \psi(\r) \times y(t).\]
Replacing in equation~\eqref{eq:time-schrodinger}, and separating the spatial
and time quantities, we get
\[- \sum \frac{\hbar^2}{2m} \frac{1}{\psi(\r)} \nabla^2 \psi(\r) + V(\r) = i\hbar \frac{1}{y(t)} \frac{\d y(t)}{\d t}.\]
For this equation to stand for all $t$ and all $r$, there must exist a constant
value $E$ such that:
\[i\hbar \frac{1}{y(t)} \frac{\d y(t)}{\d t} \quad = \quad E \quad = \quad - \sum \frac{\hbar^2}{2m} \frac{1}{\psi(\r)} \nabla^2 \psi(\r) + V(\r) \]

Putting everything together, any solution of the general
equation~\eqref{eq:time-schrodinger} can be written as a (potential infinite)
linear combination of special solutions:
\[\Psi(\r, t) = \sum_i c_i \ \psi_i(\r) \ e^{-i E_i t / \hbar},\]
with $c_i$ being the complex coefficients of the combination; and the $(E_i\ ;\
\psi_i)$ pairs are solutions of the \emph{time-independent} Schrödinger equation:
\[\hat{\mathcal{H}} \psi(\r) = E \psi(\r).\label{eq:schrodinger}\]
$\Psi$ is called a \emph{wave function} because its time dependence has a
wave-like form, and because it propagates through space and time. Solving
equation~\eqref{eq:schrodinger} gives us stationary states $(E_i\ ;\ \psi_i)$,
where $E_i$ is the energy of the state; and $\psi_i$ is the wave function of the
state. Although there is no easy interpretation of the complex valued function
$\psi_i$, its squared norm $|\,\psi_i(\r)\,|^2$ is the probability density of
finding the electrons around a given position.

\subsection{Density Functional Theory}

To compute the energy of an atomic system, we need to solve
equation~\eqref{eq:schrodinger} for a collection of $N$ electrons carrying a
negative charge $-e$ and $M$ nuclei carrying a positive charge $e\,Z_j$, all
interacting through a Coulombic potential. As the electrons are much more
lightweight than the nuclei (an electron is roughly 2000 times lighter than a
proton), it is customary to work under the Born-Oppenheimer
approximation\cite{Born1927}. In this approximation, the degrees of freedom of
electrons and nuclei are decoupled, and the electrons move much faster than the
nuclei; reacting instantly to changes in the nuclei's positions. This
effectively means that at a given point in time, the electrons evolve in the
constant electrostatic potential generated by the fixed nuclei. The
corresponding Hamiltonian (using atomic units, \ie $e^2 / 4\pi\epsilon_0 = 1$;
$\hbar = 1$; and $m_\text{electron} = 1$) is:
\[\hat{\mathcal{H}} = \left[-\frac 1 2 \sum_i^N \nabla^2_i - \sum_i^N \sum_j^M \frac{Z_j}{|\r_i - \vec R_j|} + \sum_i^N \sum_{j>i}^N \frac{1}{|\r_i - \r_j|} \right]\]
We can rewrite this by defining the potential an electron feels due to the
presence of all the nuclei $V_\text{ext}(r) = -\sum_{j} Z_j / |\r - \vec R_j|$,
and the electron-electron interaction potential $U(r_i, r_j) = 1 / |\r_i -
\r_j|$:
\[\hat{\mathcal{H}} = \left[-\frac 12\sum_{i=1}^N \nabla^2_i + \sum_{i=1}^N V_\text{ext}(\r_i) + \sum_{i=1}^N \sum_{j>i}^N U(\r_i, \r_j)\right] \]
\[\hat{\mathcal{H}} = \hat T + \hat V_\text{ext} + \hat V_{ee} \label{eq:electronic-hamiltonian}\]
The three terms in the Hamiltonian are the kinetic energy $\hat T$, the total
external potential $\hat V_\text{ext}$, and the electron-electron interaction
potential $\hat V_{ee}$.

The Density Functional Theory (DFT) is a strategy to solve the Schrödinger
equation without having to explicitly determine the wave function $\psi$. It is
based on the fact that the square of the norm of the wave function is the
probability for the system to be in a given state. For a system of electrons
evolving in the fixed potential created by the nuclei, the wave function
$\psi(\{\vec x\})$ depends on the Cartesian coordinates of all the electrons
$\{\vec x\}$. The electronic density $n(\r)$ is the probability to find an
electron in small neighboring of $\r$. It is defined as:
\[n(\r) = N \iiint |\psi(\r, \vec x_2, \cdots, \vec x_N)|^2 \ \d \vec x_2 \cdots\d \vec x_N \label{eq:electron-density}\]

Hohenberg and Kohn showed in 1964\cite{Hohenberg1964} that every electronic
density correspond exactly to one and only one external potential
$V_\text{ext}$, \ie the knowledge of the external potential or the density are
equivalent. This is the first Hohenberg and Kohn theorem. This also means that
knowing the electronic density is equivalent to knowing the wave function of the
system, as one can reconstruct it using equation~\eqref{eq:schrodinger}. As a
consequence, all the observables of the system only depend on the electronic
density, and can be written as functionals of this density: $E[n]$, $\Psi[n]$,
\etc

The second Hohenberg and Kohn theorem\cite{Hohenberg1964} states that the ground
state electronic density $n_0(\r)$ is the one that minimize the energy
functional: $E[n] \geq E_0 = E[n_0]$. From the previous relations, the total
energy functional contains three terms:
\[E[n] = T[n] + V_\text{ext}[n] + V_{ee}[n];\]
where the potential terms can be expressed as integrals of the one and two
electrons density:
\[ V_\text{ext}[n] = \int V_\text{ext}(\r) \ n(\r) \ \d \r;\]
\[ V_{ee}[n] = \iint \frac{n_2(\r_1, \r_2)}{|\r_1 - \r_2|} \ \d \r_1 \d \r_2.\]
Where the two electrons density $n_2(\r_1, \r_2)$ is the probability for an
electron to be in a small neighboring of $\r_1$, while another electron is in a
small neighboring of $\r_2$:
\[n_2(\r_1, \r_2) = N \iiint |\psi(\r_1, \r_2, \vec x_3, \cdots, \vec x_N)|^2 \ \d \vec x_3 \cdots\d \vec x_N\]

While we can compute and minimize $V_\text{ext}[n]$ given the positions of the
nuclei, the two other terms $T[n]$ and $V_{ee}[n]$ are harder to evaluate.

Kohn and Sham reformulated the problem in 1965\cite{Kohn1965} by considering a
set of \emph{non-interacting} electrons evolving in a specific external
potential, such as the density arising from these electrons is the same as the
one we look for. The new system of non-interacting electrons is described by a
new set of independent orbitals $\phi_i$, such as the total electronic density
of the system is
\[n(\r) = \sum_i^N \left| \phi_i(\r) \right|^2\]

For these non interacting electrons, the kinetic energy $T_s[n]$ is known:
\[T_s[n] = \sum_i^N \int \phi_i^*(\r) \left( -\frac 12 \nabla^2 \right) \phi_i(\r) \d \r\]
We also know that most of the $V_{ee}[n]$ term can be approximated as a
classical classical Coulombic interaction --- the so called \emph{Hartree
energy} --- which we can compute directly from the electronic density:
\[V_H[n] = \iint \frac{n(\r_1) n(\r_2)}{|\r_1 - \r_2|} \ \d \r_1 \d \r_2.\]
The functional to minimize in order to find the electronic density is now
\[E[n] = T_s[n] + V_\text{ext}[n] + V_H[n] + E_{xc}[n],\label{eq:energy-functional}\]
in which we can compute all of the terms expect for the exchange-correlation
contribution $E_{xc}[n]$.
\[E_{xc}[n] = (T[n] - T_s[n]) + (V_{ee}[n] - V_H[n]).\]
The form of this contribution is generally unknown, and it describes the quantum
nature of electrons that are able to interact with themselves. The
exchange-correlation name comes from the two different physical terms that it
encompasses. The exchange energy is a quantum-only effect due to the fact that
electrons are not distinguishable, and that exchanging two of them should change
the sign of the wave function. This exchange effect is sometimes called Pauli
repulsion, as it increases the distance between the electrons. The correlation
term describes how much the presence of other electrons influences the position
of a given electron; \ie how much the two electrons density $n_2(\r_1, \r_2)$
differs from the product of single electrons densities $n(\r_1)n(\r_2)$.

It can be shown that the minimizing the energy functional is equivalent to
solving a set of differential equations called the Kohn-Sham equations:
\[ \left[-\frac 12 \nabla^2 + V_\text{ext}(\r) + \frac{\partial V_H[n](\r)}{\partial n(\vec r)} + \frac{\partial E_{xc}[n](\r)}{\partial n(\vec r)} \right] \phi_i = \epsilon_i \phi_i \label{eq:kohn-sham}\]
These are non-linear equations, as both $V_H[n]$ and $E_{xc}[n]$ depends on the
$\phi_i$ through $n(\r)$. The usual algorithm to solve them is a self-consistent
iterative algorithm. We start by making an initial guess for the Kohn-Sham
orbitals $\phi_i^0$, for example using a linear combination of atomic orbitals.
Using this initial guess, we can
\begin{enumerate}
    \item calculate the corresponding electron density at step $\alpha$, $n^{\,\alpha}(\r)$;
    \item calculate all the terms in the left hand side of equation~\eqref{eq:kohn-sham}:
          kinetic, external, Hartree and exchange-correlation energies using this electron density;
    \item solve the Kohn-Sham equation to find new Kohn-Sham orbitals $\phi_i^{\,\alpha+1}$;
    \item compute the new energy using the energy functional~\eqref{eq:energy-functional}.
\end{enumerate}

If the new energy $E^{\,\alpha+1}$ and density $n^{\,\alpha+1}(\r)$ are the same
as the energy $E^{\,\alpha}$ and density $n^{\,\alpha}(\r)$ in the previous
step; then we have found the fixed point of the Kohn-Shame equation, and the
converged density is the solution of the Schrödinger equation. Else, we go back
to step 1 using the new Kohn-Sham orbitals as the initial guess. This cycle is
called the Self-Consistent Field method, as we iteratively solve the equations
until the solution is self-consistent.

The ground state energy $E^{\,\alpha + 1}$ and electronic density $n^{\,\alpha +
1}(\r)$ will be the values minimizing the energy functional from
equation~\eqref{eq:energy-functional}. The Kohn-Sham energies
$\{\,\epsilon_i\,\}$ on the other hand have no physical meaning. They are only
the solution of equation~\eqref{eq:kohn-sham} for a system of non-interacting
electrons that happens to have the same electronic density as the real system of
interest.

\subsection{Exchange, correlation and dispersion}

A good approximation for the exchange-correlation functional is required to
solve the Kohn-Sham equations. There are number of approach routinely used in
theoretical chemistry such as Local Density Approximation (LDA) where the
exchange-correlation functional only depends on the local density; Generalized
Gradient Approximation (GGA), where the functional also depends on the local
gradient of the density, meta-GGA functionals incorporating the second
derivative of the density (the Laplacian of the density); or hybrid functionals.
Hybrid functionals mix exchange expressions from LDA or GGA with exact exchange
term coming from other methods for solving the Schrödinger equation, such as
Hartree-Fock methods.

Generally, the exchange-correlation functional only depends on the local
density, and maybe some of its derivatives. This means that DFT calculations
will have trouble reproducing non-electrostatic long-range correlation effects,
such as the dispersion interaction. Fortunately, we have a simple analytic
formulation for these interaction, which Grimme and coworkers\cite{Grimme2006, Grimme2010}
proposed to include when computing the total energy. This correction is added to
the energy obtained by DFT, and does not directly modify the electronic density.
\[E_\text{tot} = E_\text{DFT} + E_\text{disp}; \]
This empirical correction is added to the energy obtained by DFT, and does not
directly modify the electronic density.

I used the DFT-D3 version of this correction, with zero damping\cite{Grimme2010}
and only the two body term. The correction to the energy is expressed as:
\[E_\text{disp} = - \sum_i^M\sum_{j>i}^M\left[\frac{C_6^{ij}}{R_{ij}^{\,6}} \ f_6^{ij}(R_{ij}) + \frac{C_8^{ij}}{R_{ij}^{\,8}} \ f_8^{ij}(R_{ij})\right],\]
where the sum is over all the pairs of atoms, $R_{ij}$ is the distance between
the atoms, the $C_6^{ij}$ are parameters tabulated for each element pairs and
$f_n^{ij}$ is a damping function.
\[f_n^{ij}(R) =
\begin{dcases}
    \frac{s_n}{1 + 6 \left(\frac{R}{\sigma_n \sqrt{C_8^{ij} / C_6^{ij}}}\right)^{-\alpha_n}} &\text{for } R < R_c \\
    0 &\text{for } R \geq R_c \\
\end{dcases}\]
In this expression, $s_n$ and $\sigma_n$ are parameters specifically adapted to
the exchange-correlation functional one uses. For example, when using the PBE
functional one should set $s_6 = 1.0$, $s_8 = 0.722$, $\sigma_6 = 1.217$, and
$\sigma_8 = 1.0$. $\alpha_6$ is always set to 14, and $\alpha_8$ to 16.

\subsection{Ab initio molecular dynamics}

\TODO

\newpage
\section{Adsorption of \ce{N2} in \ZIF8 and its derivatives}

In this section, I will show an example of how the use of \abinitio molecular
dynamics enables a precise description of the adsorbed phase in flexible porous
materials. The corresponding study has been published in
\citejournal{Chaplais2018}\cite{Chaplais2018}.

\subsection{\ZIF8 and its cousins}

The flexible porous material used in this study is \ZIF8. It is a representative
of the Zeolitic Imidazolate Framework (ZIF) family of MOFs, with a sodalite
(SOD) topology, methyl-imidazolate linkers, and zinc metallic centers. The
topology of \ZIF8 is represented in figure~\ref{fig:zif8-ch3:structure}.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.45\textwidth]{figures/images/ZIF8-100}
    \hfill
    \includegraphics[width=0.45\textwidth]{figures/images/ZIF8-111}
    \caption{Structure of the methyl-imidazolate \ZIF8. On the left, the
    front-most opening is the 4-member ring window (the structure is represented
    along the 001 axis); and on the right the front-most opening is the 6-member
    ring window (the structure is represented along the 111 axis). The atomic
    color code is green for zinc, blue for nitrogen, gray for carbon and white
    for hydrogen.}
    \label{fig:zif8-ch3:structure}
\end{figure}

\ZIF8 is known for it relatively high surface area of \SI{1.947}{m^2/g} and
large cavity with a diameter of \SI{11.6}{\AA}\cite{Park2006}. It is also
commercially available and have excellent performance at the lab scale for the
separation of gas mixtures such as \ce{C2}/\ce{C3} hydrocarbons,
\ce{CO2}/\ce{CH4}, or \ce{CO2}/\ce{N2}\cite{Li2009,Bux2011}. It also present an
interesting behavior with respect to flexibility of the structure during
nitrogen adsorption. \TODO

Two analogs to \ZIF8 using chloro- and bromo-substituted imidazolate linkers
instead of the original methyl-imidazolate in \ZIF8 have first synthesized by
\citeauthor{Li2009}\cite{Li2009}. These two new materials that we will call
\ZIFCl and \ZIFBr are represented in figure~\ref{fig:zif8-x:structures}.

As we will see in this chapter, these simple changes of linker are followed by
complex changes in behavior; showing in this specific example the versatility
MOFs can achieve through organic chemistry.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.45\textwidth]{figures/images/ZIF8-Cl}
    \hfill
    \includegraphics[width=0.45\textwidth]{figures/images/ZIF8-Br}
    \caption{Structure of the chloro-imidazolate \ZIFCl on the left and the
    bromo-imidazolate \ZIFBr on the right. The atomic color code is the same
    as in figure~\ref{fig:zif8-ch3:structure}, with a bright green for chlorine
    atoms and dark red for bromide atoms.}
    \label{fig:zif8-x:structures}
\end{figure}

\FloatBarrier
\subsubsection{Nitrogen adsorption isotherms in \ZIF8, \ZIFCl, and \ZIFBr}

The nitrogen adsorption isotherms at \SI{77}{K} in \ZIF8, \ZIFCl and \ZIFBr, are
presented in figure~\ref{fig:zif8x:isotherms}. They were measured as part of
collaboration by the experimental IS2M laboratory in Université de Haute Alsace,
in Mulhouse, France.

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-isotherms}
    \caption{Nitrogen adsorption isotherms at \SI{77}{K} in \ZIF8 (black) and
    the chloro (green) and bromo (red) derivatives. Full circles are used for
    the adsorption branch, and empty ones for the desorption branch.
    Experimental data acquired by\citeauthor{Chaplais2018}\cite{Chaplais2018}}
    \label{fig:zif8x:isotherms}
\end{figure}

Looking at these isotherms, we first notice that for \ZIF8, there are two jumps
in loading: a first one corresponding to the initial filling of the pores up
until around \SI{300}{cm^3/cm^3}, and the a second one up until
\SI{400}{cm^3/cm^3}. \ZIFCl shows the same behavior with a two stepped isotherm,
while \ZIFBr does not. The adsorption of nitrogen molecules at low temperature
in \ZIF8 has already been studied extensively, both experimentally and by
computational means. Early work demonstrated that the structure of \ZIF8 goes
through at least two phases during the adsorption: an ambient pressure phase
named AP, and a high pressure phase named HP. These phases mainly differ by the
orientation of the linkers around the 4 and 6-member
windows.\cite{FairenJimenez2011} A recent, more detailed characterization of the
structural evolution upon adsorption showed that the transition from AP to HP is
linked to a continuous swing (rotation) of the methyl-imidazolate linker, which
can be followed as the dihedral angle \ce{Zn-Zn-C-CH3} goes from an equilibrium
value of 7° in AP phase to an equilibrium value of 35° in HP
phase.\cite{Coudert2017} This angle is represented in
figure~\ref{fig:zif8x:swing-angle}. All this seems to indicate that the second
jump in the isotherm is related to the changes in the structure.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\textwidth]{figures/images/swing-angle}
    \caption{Representation of the swing \ce{Zn-Zn-Zn-X} dihedral angle for \ZIF8.}
    \label{fig:zif8x:swing-angle}
\end{figure}

\subsubsection{\emph{Ab initio} molecular dynamics study}
\label{sec:zif8x:methods}

In order to gain better understanding of the relation between the structure
changes and the adsorbed molecules, I used molecular dynamics (MD) simulations.
To describe fully the flexibility of the frameworks without any assumption, I
favored \abinitio MD over force field-based MD --- as there are currently no
force fields available for the \ZIF8 variants studied here. For each framework
(\ZIFCH3, \ZIFCl, \ZIFBr), I ran five simulations corresponding to different
number of nitrogen molecules inside the porous space, going from empty framework
($N = 0$) to the fully loaded host material. The maximal loading was determined
from the experimental isotherms to be close to $N = 50$ molecules per unit cell
for \ZIFCH3 and \ZIFCl and $N = 40$ molecules per unit cell for \ZIFBr.

To create the starting configurations, I started from the energy-minimized
configuration of the empty frameworks, and randomly placed the selected number
of nitrogen molecules in the unit cell using the packmol
software\cite{Martnez2009}. The whole \{ZIF, adsorbate\} system was then
minimized again at the DFT level before starting the molecular dynamics
simulations. I used the Quickstep module\cite{VandeVondele2005} of the CP2K
software package (version 2.5.1, available online at http://www.cp2k.org/) for
all the simulations. I used a PBE exchange-correlation functional with D3
dispersion corrections, a double zeta polarizable valence (DZVP) basis set, and
an energetic cutoff of 600 Ry. All the systems were simulated with a \SI{1}{fs}
timestep giving a total of 12 to \SI{22}{ps} of simulation. Temperature was held
constant at 77 K with a CVSR thermostat, using a thermostat time constant of
\SI{1000}{fs}. I used the last \SI{5}{ps} of simulation for analysis, leaving 7
to \SI{17}{ps} to the system to reach equilibrium.

We used constant volume ($NVT$) simulations instead of constant pressure ($NPT$)
simulations because $NPT$ AIMD simulations require a higher computation time to
correctly converge the calculation of forces. In general, when global
deformations are expected in the system, one should use $NPT$ simulation. In
this case, I was able to use $NVT$ simulations because the volume changes
between the different phases of \ZIF8 is very small \TODO: how much?.

\subsection{Deformation under adsorption}
\label{sec:zif8x:swing}

The first indicator of deformation of the framework is the \ce{Zn-Zn-Zn-X}
dihedral angle, where \ce{X} is the group on the imidazolate linkers: methyl,
chlorine or bromide. This angle --- represented on
figure~\ref{fig:zif8x:swing-angle} --- is also called the swing angle, noted
$\phi$. The swing angle represent the rotation of the linker around the 6-member
window plane, with 0° being the point where the linker is completely in this
plane.

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-dihedrals}
    \caption{Distribution of linker swing angle (\ce{Zn-Zn-Zn-X} dihedral angle,
    where \ce{X} stands for \ce{CH3}, \ce{Cl} or \ce{Br} for \ZIFCH3, \ZIFCl or
    \ZIFBr, respectively) at various values of nitrogen loading.}
    \label{fig:zif8x:dihedrals}
\end{figure}

Following the evolution of the distribution of swing angles as the number of
nitrogen molecules increases allow to understand the deformations of the three
framework under adsorption. This evolution is represented on
figure~\ref{fig:zif8x:dihedrals}, where we observe a gradual increase of the
mean angle value as loading increases while the distribution remains
Gaussian-like.

These results are consistent with the already published ones for
\ZIFCH3\cite{Coudert2017}, but using a different functional (PBE here instead of
BLYP). Interestingly, the two other frameworks behave differently. For \ZIFCl,
almost no change is noticed in the distribution profile upon adsorption until
the highest value of loading (\ie, $N = 50$). In this case, the distribution
shifts and the profile is no longer of Gaussian type, but instead looks like the
sum of two Gaussian distribution, one centered around 25°, and the other one
around 10°. It indicates that some of the linkers do not rotate (swing) even at
high loading. This non-zero value of the distribution at $\phi = 0\text{°}$
contrasts with the case of \ZIFCH3. Finally, for \ZIFBr, no significant change
occurs for the dihedral angle distribution as the loading increases.

Although this behavior appears to be correlated with the presence or absence of the
adsorption step in the isotherms, it is not however sufficient to explain it.
One hypothesis often formulated for \ZIFCH3 is that the swinging motion leads to
an increase of the accessible porous volume in the structure, thereby increasing
nitrogen uptake. In order to check whether this is or not the case, I computed
the pore size distribution (see figure~\ref{fig:zif8x:pores-sizes}) and the
accessible porous volume (see figure~\ref{fig:zif8x:porous-volume}) from the MD
trajectories using Zeo++\cite{Willems2012} version 0.3. In order to compute
these values, I first emptied the structure of all the nitrogen molecules, and
then computed the pores sizes distribution and accessible volume using the
remaining frameworks.

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-pores-sizes}
    \caption{Pore size distribution (no unit) under increasing loading for the
    three structures.}
    \label{fig:zif8x:pores-sizes}
\end{figure}

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-porous-volume}
    \caption{Accessible porous volume changes in the three isoreticular
    structures during adsorption. The numbers on top of the columns are the
    number of adsorbed \ce{N2} molecules.}
    \label{fig:zif8x:porous-volume}
\end{figure}

The results presented in figure~\ref{fig:zif8x:pores-sizes} highlight that the
pore size distribution (PSD) remains largely unchanged in all cases as the
loading increase and the linkers swing. The PSDs present two peaks,
corresponding to two types of cavities: a small one corresponding to the 6
member windows around \SI{10.3}{\AA} for \ZIF8 and a second one, with a much
larger contribution to the overall porous volume around \SI{11.2}{\AA} in \ZIF8.
The three PSDs are very similar, only changing in the absolute the size of
pores, in the order $\text{\ZIF8} > \text{\ZIFCl} > \text{\ZIFBr}$. This is also
reflected in the accessible volume figure~\ref{fig:zif8x:porous-volume} which
remains roughly constant as the loading increase and the linkers swing.

\subsection{Changes in the adsorbed phase}

In order to understand the origin of the step seen in the nitrogen adsorption
isotherms at \SI{77}{K}, we need to take a look at the other chemical species
participating in adsorption: the nitrogen fluid. Another hypothesis used to
explain the stepped isotherm is that nitrogen molecules undergoes a reordering
or repacking in the cavity, thereby leading to an increase in adsorbed molecules
in the same total pore volume as well as the swing of the linkers aiming to
accommodate the new packing. This hypothesis had been already proposed by
\citeauthor{Ania2012}\cite{Ania2012}, but the intermediate adsorption regime was
then not probed or interpreted.

In order to visualize this packing, I have projected the positions of all
adsorbed nitrogen atoms in the $xy$ plane and created a density map of the
adsorbed phase. This density map is shown figure~\ref{fig:zif8x:density} both at
various loadings and for the three frameworks.

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-density}
    \caption{2D density maps of the adsorbed nitrogen atoms positions in the $xy$
    plane at various loadings in \ZIF8 (top), \ZIFCl (middle), and \ZIFBr
    (bottom). The loading increases from left to right.}
    \label{fig:zif8x:density}
\end{figure}

For \ZIF8, two different molecular packing are encountered according to the
loading. With 10 or 25 molecules in the unit cell, the density maps show clear
delimited positions on a cubic-like arrangement, whereas with 40 and 50
molecules, they show a tetragonal-like arrangement of the molecules. This
reordering of the adsorbed nitrogen molecules from a cubic-like phase to a
tetragonal-like phase is at the origin of the steep uptake at low relative
pressure. For \ZIFCl, the behavior is roughly similar: the molecules first pack
in a cubic-like fashion in the cases of 10, 25 and 40 molecules per unit cell,
before a reordering toward a tetragonal-like arrangement at 50 molecules per
unit cell. This is consistent with the dihedral angles distributions as shown in
figure~\ref{fig:zif8x:dihedrals}, and evidences that the molecular packing
rearrangement happens conjointly with the swing of the linkers. It is
interesting to note that some disorder in the tetragonal arrangement remains ---
even at a loading of 50 molecules per unit cell --- as the molecules' positions
are not as well defined as the one in \ZIF8. Again, this is consistent with the
dihedral angles distribution at 50 molecules per unit cell for \ZIFCl which is
not of a single Gaussian type, indicating that this disorder can also be found
in the framework structure. For \ZIFBr, the behavior is different. A same
cubic-like arrangement is found at the lower loadings of 8 and 20 molecules per
unit cell, whereas the arrangement at the higher loadings of 40 and 50 molecules
per cell differ from the tetragonal-like one seen for \ZIF8 and \ZIFCl. Indeed,
the latter appears as a mix of the cubic and the tetragonal organization as the
molecules are mostly distributed on a cube with additional molecules in the
[111] channels on the diagonals of the cube. Consequently, because of the
absence of a clear reordering of adsorbed nitrogen molecules in \ZIFBr, its
sorption isotherm does not display the S-shaped adsorption step.

\begin{figure}[ht]
    \centering
    \input{figures/zif8x-rdf}
    \caption{Radial distribution function of nitrogen atoms in the three
    frameworks for various nitrogen loading. This represent the number of atoms
    at a given distance from the center of the cavity.}
    \label{fig:zif8x:rdf}
\end{figure}

This repacking of nitrogen molecules is also visible on the radial distribution
of nitrogen atoms (not to be confused with the pairs radial distribution
function $g(r)$) in figure~\ref{fig:zif8x:rdf}. The radial distribution counts
how many nitrogen atoms are at a given distance of the center of the sodalite
cage. On the graphs for the \ZIF8 framework, we can see the change from the
initial packing at $N = 10$ and $N = 25$ with a main peak at \SI{5}{\AA} and a
secondary peak at \SI{1}{\AA}; the final packing at $N = 50$ with three well
defined peaks at \SI{2.5}{\AA}, \SI{4.5}{\AA}, and \SI{5.5}{\AA}; and the $N =
40$ distribution which present characteristics of both extremes. Again, for
\ZIFCl, we observe the first bi-modal distribution for $N = 10$, 25 and 40; and
the tri-modal distribution for $N = 50$. And in \ZIFBr we never see the
tri-modal distribution: instead at high loadings ($N = 40$ and $N = 50$) the
curve is not well defined in the 3 to \SI{6}{\AA} range, as already seen in
figure~\ref{fig:zif8x:density}.

\subsection{Mechanism of nitrogen adsorption in \ZIF8}

To summarize this section, the proposed mechanism of nitrogen adsorption in the
three \ZIF8 frameworks with different functionalization is illustrated in a
schematic way in figure~\ref{fig:zif8x:summary}. When the pores are empty, the
linkers are in their equilibrium position, around 0°. As the loading increases,
the pores start to fill in a given, cubic-like arrangement. Then, as loading
continues to increase, in \ZIFCH3 and \ZIFCl the nitrogen molecules arrangement
changes to a tetragonal-like arrangement and the linkers rotate to accommodate
for this repacking. In \ZIFBr, the nitrogen molecules do not repack and the
linkers do not rotate.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\textwidth]{figures/images/zif8x-summary}
    \caption{Schematic overview of the adsorption process in the three \ZIF8
    frameworks. Blue is \ZIFCH3, green is \ZIFCl and red is \ZIFBr; loading
    increases from left to right.}
    \label{fig:zif8x:summary}
\end{figure}

Given that the change in functional group from methyl to chloro and bromo, does
not significantly impact partial atomic charges or the strength of the \ce{Zn-N}
coordination bond; the origin of the different soprtion features between the
three \ZIF8 derivatives does not come from a difference in flexibility or
stiffness of the linkers rotation. This is confirmed by the dihedral angles
distribution in figure~\ref{fig:zif8x:dihedrals}, where all the Gaussian
distributions have the same width, which means that all the linkers rotation
have the same stiffness. Instead, the differences in the adsorption isotherms
come from the differences in pore size and shape, the pores in \ZIFBr being
smaller than in \ZIFCl and \ZIFCH3, thus preventing a molecular reordering to
occur.

\section{Classical force fields from \abinitio data}
\label{sec:classical-ff-parametrize}

As mentioned in section~\ref{sec:zif8x:methods}, I used \abinitio molecular
dynamics to study the adsorption in the three \ZIF8 derivatives to be able to
describe the full flexibility of the frameworks without making any other
assumptions; and because there was no available force field for the material
studied. During my PhD, I have also started a collaboration with Johannes P.
Dürholt and Pr. Rochus Schmid from the Ruhr Universität in Bochum, Germany to
parametrize a classical force field for \ZIFCH3, \ZIFCl and \ZIFBr using data
from the \abinitio simulations presented above.

\subsection{Fitting a force field}

Classical force fields are fully defined by two things: (1) the choice of
functional forms used to represent the different terms (\emph{e.g.} using
Lennard-Jones, Buckingham or another form for non-bonded pair interactions); (2)
the atom-dependent parameters used in these functional forms (like the
$\epsilon$ and $\sigma$ parameters for Lennard-Jones). See
chapter~\ref{sec:classical-ff} for a more complete description of force fields.
The process of optimizing the parameters of a force-field is called the
parametrization of the force field. The idea is to use some reference data,
either from experimental properties or \abinitio computations, and optimize the
parameters to reproduce the reference data in the best possible way. Both static
properties such as crystalline structure from X-ray diffraction, and dynamic
ones such as vibrations frequencies as given by infrared spectroscopy can be
used as reference data when fitting a force field.

The force field created can then be evaluated by checking how well it can
reproduce physical properties that were not used for creating it --- for example
the melting point, or solvation energy. A good force field will be able to
reproduce most properties of a system reasonably well.

Historically, optimizing the parameters of a force-field has most often been a
manual and ad hoc process. First, we would start by setting the parameters to an
initial value by making an educated guess, then we would run a few static or
dynamic calculations with these parameters, compute and compare the properties
of interest with the reference value, and finally we would adjust the parameters
and start over, until some convergence was achieved. Convergence is measured by
a cost function that we try to minimize when changing the parameters. Creating a
force field this way is difficult and takes a lot of time. Additionally, it is
not reproducible: starting the process all over again might lead to a different
set of parameters.

\subsubsection{Transferable or accurate?}

Ideally, we want the force fields we use to be as accurate as possible when
computing the energy of a system, to be as confident as possible that the model
described by the force field describe the chemical reality as well as possible.
This means creating a specific force field for every molecule, and for every
combination of molecules. However, having separate force field for each system
we are interested in can prevent us to compare the predicted properties. We can
not ascribe with certainty the predicted differences to the underlying chemical
reality, and not the model we used. The origin of the discrepancies might also
be the use of different reference data or different functional forms, as well as
a different parametrization procedure.

This is the reason why generic force fields have also been developed. They
trade some accuracy for a better transferability: we are able to use them for
multiple molecular systems with roughly the same accuracy everywhere. The
Universal Force Field\cite{Rappe1992} (UFF) and the AMBER family\cite{Wang2004}
of force fields for bio-molecules are well known examples of such generic force
fields. Instead of defining a force field for a whole molecule, they are based
on \emph{fragments}. For example methanoic acid \ce{HCO2H} would contain
\ce{C-H}, \ce{C-O}, \ce{C=O}, and \ce{O-H} bond fragments; as well as
\ce{H-C=O}, \ce{O-C=O}, \ce{C-O-H} angles and \ce{O=C-O-H} dihedral angle. The
same fragments would also be used in ethanoic acid \ce{CH3CO2H}, or any other
carboxylic acid.

\subsection{Systematic parametrization of force fields}

One way to overcome the previously mentioned issues (long parametrization time,
non reproducible parametrization, trade-off between transferable and accurate
force fields) is to use a systematic parametrization algorithm. Using an
algorithm will improve the parametrization time although the generated force
field should still be validated. We can also design the algorithm to give us
reproducible parametrization. Finally, using the same algorithm for all the
systems of interest should help with accuracy --- as each system has parameters
specifically fitted for it --- while still allowing comparison between different
systems because they would share the functional form and kind of input data with
all the others systems.

MOF-FF\cite{Bureekaew2013} is one of the algorithm proposed for systematic
parametrization of force fields. It uses \abinitio reference data, specifically
the optimized geometry of the system, and the Hessian matrix at this optimized
geometry, decomposed on a base on internal coordinates. The Hessian matrix $H$
contains the second derivatives of the energy with respect to two internal
coordinates. To optimized the parameters, it uses a genetic algorithm: starting
from a population of randomly created parameter sets, it evaluate the cost for
function for all of them. Then --- mimicking evolution and natural selection ---
the weakest sets (the ones with the highest cost) are eliminated, and the
remaining sets are combined to create a new generation of parameters set. New
generations are created until the cost function is minimal over the whole
generation. In this last generation, the best parameter set is the new force
field.

The score function used when optimizing the parameters is defined for a
parameter set $P$ as:
\[
\begin{aligned}
    Z(P) &= \alpha_\text{bonds} \sum_\text{bonds} w_i \ \left[r_i\,(P) - r_i^{ref}\right]^2 \\
         &+ \alpha_\text{dihedrals} \sum_\text{dihedrals} w_i \ \left[\phi_i\,(P) - \phi_i^{ref}\right]^2 \\
         &+ \alpha_\text{diag} \sum_m w_{mm} \ \left[H_{mm}(P) - H_{mm}^{ref}\right]^2 \\
         &+ \frac 1 9 \sum \left[C^{-1} \cdot (S \cdot V)^2\right]^2 \\
\end{aligned}
\begin{aligned}
    &+ \alpha_\text{angles} \sum_\text{angles} w_i \ \left[\theta_i\,(P) - \theta_i^{ref}\right]^2 \\
    &+ \alpha_\text{impropers} \sum_\text{impropers} w_i \ \left[\delta_i\,(P) - \delta_i^{ref}\right]^2 \\
    &+ \alpha_\text{non-diag} \sum_k \sum_{m\neq k} w_{km} \ \left[H_{km}(P) - H_{km}^{ref}\right]^2 \\
    &~
\end{aligned}
\]

All terms are squared mean deviations, weighted both by $w_i$ to set the relative
importance of similar terms; and $\alpha_x$ to set the relative importance of
different terms. The first four terms account for equilibrium values of
geometric parameters, the following two account for the diagonal and out of
diagonal contributions to the Hessian of the system, \ie the dynamics of the
system around equilibrium. The last term contains the unit cell matrix $C$, the
stress $S$ and the unit cell volume $V$, and is used to minimize the resulting
total stress on the periodic system.

MOF-FF is based on the MM3 functional form\cite{Allinger1989}, and some of the
parameters are fixed before starting the optimization. In particular, atomic
charges are computed directly from the \abinitio reference and represented as
atom-centered spherical Gaussians, while the dispersion interaction is modeled
with a Buckingham potential, using the tabulated parameters for
MM3\cite{Allinger1994}. The remaining intra-molecular parameter are optimized in
order to make sure the overall potential reproduces the reference data.

We used MOF-FF to generate new force fields for \ZIFCH3, \ZIFCl, and \ZIFBr,
using data from the simulations previously described for parametrization and
validation. At the same time, we improved the fitting strategy to use periodic
boundary condition in the \abinitio input data; and CMA-ES (Covariance Matrix
Adaptation Evolution Strategy) as the genetic algorithm for optimization.
Interested reader should refer to the corresponding article\cite{DuerholtXXXX}
for more information and the force field parameters.

\subsection{Validating the generated force-fields}

\begin{figure}[t]
    \centering
    \input{figures/mof-ff-validation}
    \caption{Comparisons of (a), (b) and (c): geometric parameters and (d):
    vibrational normal modes between the reference DFT data and the new MOF-FF
    force field.}
    \label{fig:fig:mof-ff:validation}
\end{figure}

After generating the force field, we multiple classical simulations to validate
it. We first checked the equilibrium properties, starting from an
energy-minimized structure. We could then extract geometric parameters such as
bonds lengths, or angles and dihedral angles equilibrium value; as well as
vibrational normal modes. We computed vibrational normal modes by using finite
differences to compute the full system Hessian in Cartesian coordinates; and
then diagonalizing the mass-weighted Hessian to extract normal modes
frequencies. These properties are compared to DFT calculations in
figure~\ref{fig:fig:mof-ff:validation}; and overall the new MOF-FF force field
is able to reproduce all of them very well. It over estimate the frequency of
vibrational modes after \SI{1500}{cm^{-1}}. These modes are very localized and
involve distortions of the linkers aromatic rings, which are not explicitly
described in the force field. A way to improve the description of these modes
would be to incorporate cross-terms (terms coupling multiples geometric
parameters, \ie a bond length and an angle, \dots) in the force field.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.32\textwidth]{figures/images/mof-ff-dihedrals-CH3}
    \includegraphics[width=0.32\textwidth]{figures/images/mof-ff-dihedrals-Cl}
    \includegraphics[width=0.32\textwidth]{figures/images/mof-ff-dihedrals-Br}
    \caption{Comparison of dihedral swing angle distribution in empty frameworks
    for the reference DFT simulations and the new MOF-FF force field.}
    \label{fig:fig:mof-ff:swing}
\end{figure}

Finally, we also ran constant temperature classical molecular dynamics using the
generated force field with the DL\_POLY software. From these simulations, we
computed the same swing angle distribution as in section~\ref{sec:zif8x:swing},
which are represented in figure~\ref{fig:fig:mof-ff:swing}. The general shape of
the DFT distributions is reproduced reasonably well by MOF-FF, but the central
value of the Gaussians is shifted by 5° for \ZIFCl and \ZIFBr; and by 10° for
\ZIFCH3. However, these differences are of the same order of magnitude as the
differences between the distributions generated by using a different DFT
functional such as BLYP\cite{Coudert2017}.

\OnlyInSubfile{\printbibliography}

\end{document}
