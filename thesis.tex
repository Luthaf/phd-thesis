\documentclass[11pt, a4paper]{book}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{classicthesis}
\usepackage[greek, english]{babel}
\usepackage{libertine}
\usepackage{inconsolata}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage[frenchmath]{mathastext}
\usepackage{dsfont}
\usepackage{subfiles}
\usepackage{graphicx}
\usepackage{tabularx}
\usepackage{microtype}
\usepackage{xspace}
\usepackage{mdframed}
\usepackage{placeins}
\usepackage{booktabs}
\usepackage{afterpage}
\usepackage{xpatch}
\usepackage{pifont}
\usepackage{newunicodechar}
\usepackage[parfill]{parskip}
\usepackage[autostyle=false, style=english]{csquotes}
\usepackage[font={it}]{caption}
\usepackage[titletoc]{appendix}
\usepackage{pgfornament}
\usepackage[
    backend=biber,
    bibencoding=utf8,
    maxbibnames=99,
    maxcitenames=1,
    url=false,
    sorting=none,
    citestyle=numeric-comp,
]{biblatex}

\usepackage[version=4]{mhchem}
\usepackage{braket}
\usepackage{siunitx}

\usepackage[outputdir=build]{minted}

% Max compression level for PDF 1.5
\pdfminorversion=5
\pdfcompresslevel=9
\pdfobjcompresslevel=3

% Automagically transform "foobar" to ``foobar''
\MakeOuterQuote{"}

% No Overfull hbox warning for less than 1pt
\hfuzz=1pt

% Float placement rules, from https://aty.sdsu.edu/bibliog/latex/floats.html
\renewcommand{\topfraction}{0.9}	% max fraction of floats at top
\renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
%  Parameters for TEXT pages (not float pages):
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
\renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
% Parameters for FLOAT pages (not text pages):
\renewcommand{\floatpagefraction}{0.8}	% require fuller float pages
% N.B.: floatpagefraction MUST be less than topfraction !!
\renewcommand{\dblfloatpagefraction}{0.8}	% require fuller float pages

% space left between floats (default is 12.0pt plus 2.0pt minus 2.0pt).
\setlength{\floatsep}{\parskip}
% space left on top and bottom of an in-text float (default is 12.0pt plus 2.0pt minus 2.0pt).
\setlength{\intextsep}{\parskip}
% space between last top float or first bottom float and the text (default is 20.0pt plus 2.0pt minus 4.0pt).
\setlength{\textfloatsep}{2\parskip}

% Recompile the figures as needed
\immediate\write18{cd figures && make}

\graphicspath{{./}{./figures/}}

% Quotations with a markdown style
\surroundwithmdframed[linewidth=2pt,topline=false,bottomline=false,rightline=false]{quote}
\AtBeginEnvironment{quote}{\itshape}

\makeatletter
% Ensure hyperref produce the right links by adding a phantomsection before addcontentsline
\let\@oldaddcontentsline\addcontentsline
\renewcommand{\addcontentsline}{\phantomsection\@oldaddcontentsline}

% Prevent line break inside multiple citations like [4-5,7], but allow it
% before the opening [
\let\@oldcite\cite
\renewcommand{\cite}[1]{\penalty1000\mbox{\@oldcite{#1}}}

\let\@oldchapter\chapter
% Skip at least one page before chapter (OnlyInMainfile), and print toc after
\newcommand{\@chapterstar}[1]{
    \OnlyInMainfile{\clearpage\pagestyle{empty}\null}%
    \@oldchapter*{#1}%
    \pagestyle{fancy}%
}
\newcommand{\@chapternostar}[1]{
    \OnlyInMainfile{\clearpage\pagestyle{empty}\null}%
    \@oldchapter{#1}%
    \pagestyle{fancy}%
    \startcontents[chapters]\printpartialtoc% only print TOC for numbered chapters
    \vskip0.5\baselineskip%
}
\renewcommand{\chapter}{\@ifstar{\@chapterstar}{\@chapternostar}}

% Use the chapter* style for table of contents, but without adding itself
% to the TOC ...
\renewcommand\tableofcontents{%
    \hrule\relax
    \vspace*{.9\baselineskip}%
    \raggedright{\huge\spacedallcaps{\contentsname}}\par%
    \vspace*{1.1\baselineskip}%
    \hrule\relax
    \vspace*{\baselineskip}%
    \@starttoc{toc}%
}

% Only expand the argument in a subfile/not in a subfile
\ifdef{\old@document@subfiles}%
    {\def\OnlyInSubfile#1{#1}\def\OnlyInMainfile#1{}}%
    {\def\OnlyInSubfile#1{}\def\OnlyInMainfile#1{#1}}

\newcommand{\printglobalbibliography}{
    \begingroup
        % Use initials for author names in the general bibliography
        \makeatletter\toggletrue{abx@bool@giveninits}\makeatother
        % Give more leeway to LaTeX when trying to typeset overfull paragraphs
        \setlength{\emergencystretch}{2em}
        \printbibliography
    \endgroup
}
\makeatother

% A bibheading using subsections
\defbibheading{subsectionbibheading}{\subsection*{#1}}

\DeclareCiteCommand{\citejournal}
    {\usebibmacro{prenote}}
    {%
        \usebibmacro{journal}%
        \setunit{\addspace(}%
        {\printfield{year})\xspace}%
    }
    {\multicitedelim}
    {\usebibmacro{postnote}}

\DeclareFieldFormat{doi}{%
    \color{CTurl}\small%
    \mkbibacro{DOI}\addcolon\space%
    \ifhyperref%
        {\href{https://doi.org/#1}{\nolinkurl{#1}}}%
        {\nolinkurl{#1}}%
}

% An enumerate like environement for the publication list
\newcounter{pubcount}
\setcounter{pubcount}{0}
\defbibenvironment{publist}
    {
        \begin{enumerate}
        \setcounter{enumi}{\thepubcount}
    }
    {
        \setcounter{pubcount}{\theenumi}
        \end{enumerate}
    }
    {\item}

% Use \[ and \] for all equations, and make all equations numbered
\def\[{\begin{equation}}
\def\]{\end{equation}}

% Partial TOC formatting for chapters
\newcommand{\printpartialtoc}{%
    \begingroup
        \hypersetup{hidelinks}
        \printcontents[chapters]{}{1}{\setlength\parskip{0pt}}%
        \hfill\pgfornament[width=6cm,color=CTsemi]{88}\hfill\hfill
    \endgroup
}

% Add hyphenation rule for bibliography
\hyphenation{Chem-Phys-Chem}
\hyphenation{Geor-geault}

% Convenience macros
%% Math stuff
\let\phi\varphi
\let\epsilon\varepsilon
\let\vec\mathnormalbold
\def\d{\text{d}}
\let\oldring\r
\def\r{\vec{r}}
\def\p{\vec{p}}
\def\v{\vec{v}}
\def\smallo{{\scriptstyle\mathcal{O}}}
\def\erfc{{\normalfont\text{erfc}}}
\def\erf{{\normalfont\text{erf}}}
% Fix formatting of \neq with mathastext
\def\neq{\not\kern0.2ex=}
% Text stuff
\def\AA{\text{\oldring{A}}}
\def\ZIF8{\mbox{ZIF-8}}
\def\ZIFCH3{\ZIF8(\ce{CH3})\xspace}
\def\ZIFCl{\ZIF8(Cl)\xspace}
\def\ZIFBr{\ZIF8(Br)\xspace}
\def\abinitio{\emph{ab initio}\xspace}
\def\Cudhbc{Cu(dhbc)$_\text{2}$(4,4$^\prime$-bpy)\xspace}
\def\RPMZn{RPM3-Zn\xspace}
\def\smallce#1{\ensuremath{\text{\tiny\ce{#1}}}}
\def\ie{\emph{i.e.}\xspace}
\def\etc{\emph{etc.}\xspace}
\def\vdW{van der Waals\xspace}
\def\cxx{{C\nolinebreak[4]\hspace{-.05em}\raisebox{.2ex}{\footnotesize ++}}\xspace}

\newunicodechar{✓}{\ding{51}}
\newunicodechar{✗}{\ding{55}}

% PSL cover page
\usepackage{psl-cover}
\pslassetspath{figures/psl}

\title{Simulation moleculaire multi-échelles de l'adsorption de fluides dans les matériaux nanoporeux flexibles}
\entitle{Molecular simulation of fluid adsorption in flexible nanoporous materials at multiple scales}
\author{Guillaume \textsc{Fraux}}

\input{cover}

\addsectionbib{publications.bib}
\bibliography{thesis, publications}

\addto\captionsenglish{\renewcommand{\contentsname}{Table of contents}}

% DRAFT code, to be commented out/removed in final version
\makeatletter
    % Add a visual marker for overrfull boxes
    \overfullrule=2em
    % Output more data in log concerning underfull boxes
    % \showboxbreadth=50 \showboxdepth=50
    % Add the date/hour of compilation on each page
    \ct@draftingtrue

    % % Use a big red box for TODO items
    % \def\TODO{\colorbox{red}{TODO}}

    % Put a big red square for undefined references
    \def\@setref#1#2#3{%
        \ifx#1\relax
            \protect\G@refundefinedtrue
            \nfss@text{\reset@font\bfseries\colorbox{red}{??}}%
            \@latex@warning{Reference `#3' on page \thepage \space undefined}%
        \else
            \expandafter#2#1\null
        \fi%
    }
\makeatother

\begin{document}
    \pagenumbering{roman}
    \maketitle

    \begingroup
        \addtocontents{toc}{\protect\thispagestyle{empty}}
        \pagestyle{empty}
        \hypersetup{hidelinks}
        \tableofcontents
        % Force a clear page so that the last page of toc use pagestyle{empty}
        \clearpage
    \endgroup

    \pagestyle{fancy}
    \input{0-intro}
    \subfile{1-context}
    \subfile{2-macroscopic}
    \subfile{3-molsim}
    \subfile{4-abinitio}
    \subfile{5-classical}
    \subfile{6-software}
    \input{9-conclusion}

    \addtocontents{toc}{\protect\contentsline{chapter}{\hfill\hfill%
                \protect\pgfornament[width=6cm,color=CTsemi]{88}%
                \hfill}{\protect\relax}{}}
    \appendix
    \subfile{A-chemfiles}

    \input{publist}

    \printglobalbibliography

    % \subfile{Z-resume-fr}

\end{document}
