\documentclass[11pt, a4paper]{book}
\usepackage[linedheaders, drafting]{classicthesis}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{libertine}
\usepackage{mathtools}
\usepackage[frenchmath]{mathastext}
\usepackage{subfiles}
\usepackage[]{graphicx}
\usepackage{tabularx}
\usepackage{xspace}
\usepackage{float}
\usepackage{mdframed}
\usepackage{placeins}
\usepackage{booktabs}
\usepackage[parfill]{parskip}
\usepackage[autostyle=false, style=english]{csquotes}
\usepackage[font={it}]{caption}
\usepackage[
    backend=biber,
    bibencoding=utf8,
    maxbibnames=99,
    maxcitenames=1,
    url=false,
    sorting=none,
    citestyle=numeric-comp,
]{biblatex}

\usepackage[version=4]{mhchem}
\usepackage{braket}
\usepackage{siunitx}

\MakeOuterQuote{"}

% No Overfull hbox warning for less than 10pt
\hfuzz=10pt
\overfullrule=2em

% Float placement rules, from https://aty.sdsu.edu/bibliog/latex/floats.html
\renewcommand{\topfraction}{0.9}	% max fraction of floats at top
\renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
%  Parameters for TEXT pages (not float pages):
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
\renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
% Parameters for FLOAT pages (not text pages):
\renewcommand{\floatpagefraction}{0.8}	% require fuller float pages
% N.B.: floatpagefraction MUST be less than topfraction !!
\renewcommand{\dblfloatpagefraction}{0.8}	% require fuller float pages

% Put a big red square for undefined references
\def\@setref#1#2#3{%
    \ifx#1\relax
        \protect\G@refundefinedtrue
        \nfss@text{\reset@font\bfseries\colorbox{red}{??}}%
        \@latex@warning{Reference `#3' on page \thepage \space undefined}%
    \else
        \expandafter#2#1\null
    \fi%
}

% Recompile the figures as needed
\immediate\write18{cd figures && make}

\graphicspath{{./}{./figures/}}

% Quotations with a markdown style
\surroundwithmdframed[linewidth=2pt,topline=false,bottomline=false,rightline=false]{quote}
\AtBeginEnvironment{quote}{\itshape}

% Make hyperref produce the right links by adding a phantomsection before addcontentsline
\let\OldAddcontentsline\addcontentsline
\renewcommand{\addcontentsline}{\phantomsection\OldAddcontentsline}

% Alternatives to \chapter*/\section* that adds themselves to the TOC
\newcommand{\nonumchapter}[1]{\chapter*{#1}\addcontentsline{toc}{chapter}{#1}\markboth{#1}{#1}}
\newcommand{\nonumsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}\markboth{#1}{#1}}

\DeclareCiteCommand{\citenum}{}{\printfield{labelnumber}}{}{}
% A bibheading using subsection*
\defbibheading{subsectionbibheading}{\subsection*{#1}}

\DeclareCiteCommand{\citejournal}
    {\usebibmacro{prenote}}
    {%
        \usebibmacro{journal}%
        \setunit{\addspace(}%
        {\printfield{year})\xspace}%
    }
    {\multicitedelim}
    {\usebibmacro{postnote}}

\DeclareFieldFormat{doi}{%
    \color{CTurl}\small%
    \mkbibacro{DOI}\addcolon\space%
    \ifhyperref%
        {\href{https://doi.org/#1}{\nolinkurl{#1}}}%
        {\nolinkurl{#1}}%
}

% An enumerate like environement for the publication list
\newcounter{pubcount}
\setcounter{pubcount}{0}
\defbibenvironment{publist}
    {
        \begin{enumerate}
        \setcounter{enumi}{\thepubcount}
    }
    {
        \setcounter{pubcount}{\theenumi}
        \end{enumerate}
    }
    {\item}

% Use \[ and \] for all equations, and make all equations numbered
\def\[{\begin{equation}}
\def\]{\end{equation}}

% Only expand the argument in a subfile
\makeatletter
\ifdef{\old@document@subfiles}%
    {\def\OnlyInSubfile#1{#1}}%
    {\def\OnlyInSubfile#1{}}
\makeatother

% Partial TOC formatting for chapters
\newcommand{\printpartialtoc}{%
    \begingroup
        \hypersetup{hidelinks}
        \hrule\vspace*{3pc}%
        \printcontents[chapters]{}{1}{\setlength\parskip{0pt}}%
        \vspace*{0.8pc}\hrule
    \endgroup
}

% Add hyphenation rule for journal names
\hyphenation{Chem-Phys-Chem}

% Convenience macros
%% Math stuff
\let\phi\varphi
\let\epsilon\varepsilon
\let\vec\mathnormalbold
\def\d{\text{d}}
\let\oldring\r
\def\r{\vec{r}}
\def\p{\vec{p}}
\def\v{\vec{v}}
\def\smallo{{\scriptstyle\mathcal{O}}}
%ù Text stuff
\def\AA{\text{\oldring{A}}}
\def\ZIF8{\mbox{ZIF-8}}
\def\ZIFCH3{\ZIF8(\ce{CH3})\xspace}
\def\ZIFCl{\ZIF8(Cl)\xspace}
\def\ZIFBr{\ZIF8(Br)\xspace}
\def\abinitio{\emph{ab initio}\xspace}
\def\Cudhbc{Cu(dhbc)$_\text{2}$(4,4$^\prime$-bpy)\xspace}
\def\RPMZn{RPM3-Zn\xspace}
\def\smallce#1{\ensuremath{\text{\tiny\ce{#1}}}}
\def\ie{\emph{i.e.}\xspace}
\def\etc{\emph{etc.}\xspace}
\def\vdW{van der Waals\xspace}

\def\TODO{\colorbox{red}{TODO}}

% PSL cover page
\usepackage[nomaketitle]{psl-cover}
\pslassetspath{figures/psl}

\title{Simulation moleculaire multi-échelles de l'adsorption de fluides dans les matériaux nanoporeux flexibles}
\entitle{Molecular simulation of fluid adsorption in flexible nanoporous materials at multiple scales}
\author{Guillaume \textsc{Fraux}}

\institute{Chimie ParisTech}
\doctoralschool{Chimie Physique et\\ Chimie Analytique de\\ Paris Centre}{388}
\specialty{Chimie Physique}
\date{25 juin 2019}

\jurymember{1}{Sofía \textsc{Calero}}{Professeure, Universidad Pablo de Olavide}{Rapporteuse}
\jurymember{2}{Paul \textsc{Fleurat-Lessard}}{Professeur, Université de Bourgogne}{Rapporteur}
% TODO: Président?
\jurymember{3}{Caroline \textsc{Mellot-Draznieks}}{Directrice de Recherches, Collège de France}{Examinatrice}
\jurymember{4}{Renaud \textsc{Denoyel}}{Directeur de Recherches, Aix-Marseille Université}{Examinateur}
\jurymember{5}{Alain H. \textsc{Fuchs}}{Professeur, PSL Université}{Examinateur}
\jurymember{6}{François-Xavier \textsc{Coudert}}{Chargé de Recherches, Chimie ParisTech}{Directeur de thèse}

\frabstract{\TODO}

\enabstract{\TODO}

\frkeywords{\TODO}
\enkeywords{\TODO}

\addsectionbib{publications.bib}
\bibliography{thesis, publications}

\begin{document}
    \pslcover

    \begingroup
        \hypersetup{hidelinks}
        \tableofcontents
    \endgroup

    \include{intro}
    \subfile{context}
    \subfile{macroscopic}
    \subfile{sampling}
    \subfile{ab-initio}
    \subfile{classical}
    \subfile{hybrid}
    \include{conclusion}

    \appendix
    \subfile{softwares}
    \subfile{electrostatics}

    % List of publications
    \clearpage
    \begin{refsection}[publications.bib]
        \newrefcontext[sorting=ynt]
        \DeclareFieldFormat{labelnumberwidth}{#1}
        \nocite{*}

        \nonumchapter{List of Publications}
        \section*{Publications related to this work}
        \printbibliography[heading=subsectionbibheading,title={Peer-reviewed Journals},type=article,env=publist,keyword={phd}]
        \printbibliography[heading=subsectionbibheading,title={Preprints},type=unpublished,env=publist]

        \section*{Publications linked to previous work}
        \printbibliography[heading=none,type=article,env=publist,keyword={previous}]
    \end{refsection}

    \printbibliography[heading=bibintoc]

    \subfile{resume-fr}

\end{document}
