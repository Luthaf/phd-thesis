\documentclass[11pt, a4paper]{book}
\usepackage[linedheaders, dottedtoc, drafting, beramono=false]{classicthesis}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[osf]{libertine}
\usepackage{subfiles}
\usepackage[draft]{graphicx}
\usepackage{tabularx}
\usepackage{xspace}
\usepackage{float}
\usepackage[
    backend=biber,
    bibencoding=utf8,
    defernumbers=true,
    maxbibnames=99,
    url=false
]{biblatex}

\usepackage[version=4]{mhchem}
\usepackage{siunitx}

% No Overfull hbox warning for less than 10pt
\hfuzz=10pt
\overfullrule=2em

% Float placement rules, from https://aty.sdsu.edu/bibliog/latex/floats.html
\renewcommand{\topfraction}{0.9}	% max fraction of floats at top
\renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
%  Parameters for TEXT pages (not float pages):
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
\renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
% Parameters for FLOAT pages (not text pages):
\renewcommand{\floatpagefraction}{0.8}	% require fuller float pages
% N.B.: floatpagefraction MUST be less than topfraction !!
\renewcommand{\dblfloatpagefraction}{0.8}	% require fuller float pages

% Put a big red square for undefined references
\def\@setref#1#2#3{%
    \ifx#1\relax
        \protect\G@refundefinedtrue
        \nfss@text{\reset@font\bfseries\colorbox{red}{??}}%
        \@latex@warning{Reference `#3' on page \thepage \space undefined}%
    \else
        \expandafter#2#1\null
    \fi%
}

% Recompile the figures as needed
\immediate\write18{cd figures && make}

\graphicspath{{./}{./figures/}}

% Make hyperref produce the right links by adding a phantomsection before addcontentsline
\let\OldAddcontentsline\addcontentsline
\renewcommand{\addcontentsline}{\phantomsection\OldAddcontentsline}

% An alternative to \chapter* that adds itself to the TOC
\newcommand{\nonumchapter}[1]{\chapter*{#1}\addcontentsline{toc}{chapter}{#1}\markboth{#1}{#1}}
\DeclareCiteCommand{\citenum}{}{\printfield{labelnumber}}{}{}
% A bibheading using subsection*
\defbibheading{subsectionbibheading}{\subsection*{#1}}

% Use \[ and \] for all equations, and make all equations numbered
\def\[{\begin{equation}}
\def\]{\end{equation}}

% Create a \subfilebibliography command that print bibliography when subfiles
% are compiled alone, and nothing when they are part of the main document.
\makeatletter
\ifdef{\old@document@subfiles}{%
  \newcommand{\subfilebibliography}{\printbibliography}%
}{%
 \newcommand{\subfilebibliography}{}%
}%
\makeatother

% Convenience macros
\def\ZIF8{\mbox{ZIF-8}}
\def\abinitio{\emph{ab initio}\xspace}
\def\d{\text{d}}
\def\Cudhbc{Cu(dhbc)$_\text{2}$(4,4$^\prime$-bpy)\xspace}
\def\RPMZn{RPM3-Zn\xspace}
\def\smallce#1{\ensuremath{\text{\tiny\ce{#1}}}}

\title{Molecular simulation of fluid adsorption in flexible nanoporous materials at multiple scales}
\author{Guillaume Fraux}

\addsectionbib{publications.bib}
\bibliography{thesis, publications}

\begin{document}
    \maketitle

    \begingroup
        \hypersetup{hidelinks}
        \tableofcontents
    \endgroup

    \include{intro}
    \subfile{context}
    \subfile{thermodynamics}
    \subfile{ab-initio}
    \subfile{classical-intrusion}
    \subfile{hybrid-monte-carlo}
    \include{conclusion}

    \appendix
    \subfile{softwares}
    \subfile{electrostatics}

    % List of publications
    \clearpage
    \begin{refsection}[publications.bib]
        \newrefcontext[sorting=ynt]
        \DeclareFieldFormat{labelnumberwidth}{#1}
        \nocite{*}

        \nonumchapter{List of Publications}
        \section*{Publications linked to my PhD work}
        \printbibliography[heading=subsectionbibheading,title={Peer-reviewed Journals},type=article,resetnumbers=true,keyword={phd}]
        \printbibliography[heading=subsectionbibheading,title={Preprints},type=unpublished,resetnumbers=true]

        \section*{Publications linked to previous work}
        \printbibliography[heading=none,type=article,resetnumbers=true,keyword={previous}]
    \end{refsection}

    \printbibliography[heading=bibintoc]

\end{document}
